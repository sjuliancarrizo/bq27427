# Writing Documentation for Component

This document covers our documentation process for component.

> [!CAUTION]
> Currently, the doc build system is broken. However, GitHub Action workflow
> is working. You cannot locally generate the documentation on local machine,
> but the workflow builds and publishes the doc when you commit.


In short, to generate HTML files, run:
```shell
make
```

When header files are updated, be sure to run `clean` target.

```sh
make clean all
```

<!-- vim-markdown-toc GFM -->

* [Requirements](#requirements)
* [Files and Directories](#files-and-directories)
* [`Makefile` targets](#makefile-targets)
    * [`all` Target](#all-target)
    * [`html` Target](#html-target)
    * [`build-doxygen` Target](#build-doxygen-target)
    * [`clean` Target](#clean-target)
* [Writing documentation](#writing-documentation)
* [Deploying the documentation](#deploying-the-documentation)

<!-- vim-markdown-toc -->

## Requirements

Install the following software.

* [GNU make](https://www.gnu.org/software/make/)
* [doxygen](https://www.doxygen.nl/)
* [sphinx](https://www.sphinx-doc.org/)
* [sphinx_rtd_theme](https://sphinx-rtd-theme.readthedocs.io/)
* [breathe](https://breathe.readthedocs.io/)
* [ruby](https://www.ruby-lang.org/) (for `bin/eil-q`)

`sphinx` is used because the default HTML files generated by `doxygen` looks
not so human-friendly.

`breathe` and `sphinx_rtd_theme` are extensions of `sphinx`.

## Files and Directories

* `index.rst` The top page of the documentation
* `conf.py` Configuration file for `sphinx` (and `breathe`)
* `doxygen.conf` Configuration file for `doxygen`
* `Makefile` GNU Makefile to automate HTML generation
* `doxygen.log` Log file of `doxygen` (can be safely removed)
* `_docs/xml` Output directory for `doxygen` (can be safely removed)
* `_build/html` Output directory for `sphinx` (can be safely removed)

## `Makefile` targets

`Makefile` has a few targets to build the documentation. The most notable ones
are:

* `make all` or `make`
* `make clean`

### `all` Target

This is the default target, which invokes `html` target.

```shell
make all

# or

make
```

### `html` Target

This target generates HTML files after invoking `build-doxygen`.

```shell
make html
```

The generated HTML files is under `_build/html` directory. To see the HTML
files, run:

```shell
firefox _build/html/index.html
```

By default, warnings are treated as errors. To ignore errors, probably because
the code is old and fixing it takes a long time, use `SPHINX_FLAGS`, which
overrides the default value.


```sh
make SPHINX_FLAGS=""
```

There are other variables that can be overridden in `Makefile`, such as variables
assigned with `?=`.

```make
FOO?=   bar
```

### `build-doxygen` Target

This target parses the source code (header files only).

```shell
make build-doxygen
```

### `clean` Target

This targets clean up unnecessary files and directories. Be sure to run this
target when header files are modified.

```shell
make clean
```

Update the HTML files.

```sh
make clean all
```

## Writing documentation

The overview of the documentation process is:

1. Write API documentation in the code
1. Write `index.rst` and reference the API documentation from it by
   `doxygenfile` directive
1. Generate HTML files by `make`
1. Verify the result and fix issues until the output is satisfactory
1. Clean uo by `make clean` (optional).

When writing a component, describe functions, macros, structures, among other
things, in the code. Read how to document APIs at:
[Writing API Description](https://docs.espressif.com/projects/esp-docs/en/latest/writing-documentation/writing-api-documentation.html).
The API documentation in the code is parsed by `doxygen`. The output of
`doxygen` can be later used in documentation files under this directory, such
as `index.rst`.

In addition to the API documentation, `index.rst` is where additional
information, such as usages, notes, and warnings are documented.

Read
[Basic Syntax](https://docs.espressif.com/projects/esp-docs/en/latest/writing-documentation/basic-syntax.html)
at
[ESP-Docs User Guide](https://docs.espressif.com/projects/esp-docs/en/latest/)
for general formatting rules.

To include the automatically generated API documentation, `doxygenfile`
([the documentation](https://breathe.readthedocs.io/en/latest/directives.html#doxygenfile))
is the directive to generate the appropriate output for the contents of a
source file. If the component has just a single header file, `filename.h` for
instance,  this is what you need in `index.rst`.

```rst
Welcome to Foo's documentation!
===============================

.. doxygenfile:: filename.h
```

## Deploying the documentation

By default, the documentation is published on GitHub Pages when the component
has been released. See [publish-gh-pages.yml](../.github/workflows/publish-doc.yml])
and `build-docs.yml` at
[esp-idf-lib/shared-workflows](https://github.com/esp-idf-lib/shared-workflows/tree/main/.github/workflows).
